{%- extends "blog/blogpage/base.html" -%}
{%- import "bootstrap_wtf.html" as wtf -%}

{%- block vars -%}
{{ super() }}
const URL_ABS_ADD_COMMENT = "{{ url_for('blog.add_comment', _external=True) }}";
const URL_ABS_DELETE_COMMENT = "{{ url_for('blog.delete_comment', _external=True) }}";
const URL_ABS_POST_PERMANENT_LINK = "{{ url_for('blog.post_by_id', post_id=post.id, _external=True) }}";
const POST_ID = "{{ post.id }}";
{%- endblock -%}

{%- block title -%}
{{ post.title }} - {{ blogpage.title }}
{%- endblock -%}

{%- block content %}
<div class="pt-2 shrinking-font-14">
    <h1 class="post-title custom-green mb-0">{{ post.title }}</h1>
  {%- if post.subtitle is not none %}
    <h2 class="post-subtitle custom-orange mt-1 mb-0">{{ post.subtitle }}</h2>
  {%- endif %}
  <div class="d-flex align-items-center mt-2half">
    {%- if post.edited_timestamp is not none %}
      <h3 class="post-timestamp black mb-0">{{ moment(post.timestamp).format("l") }} | Edited {{ moment(post.edited_timestamp).format("l") }}</h3>
    {%- else %}
      <h3 class="post-timestamp black mb-0">{{ moment(post.timestamp).format("l") }}</h3>
    {%- endif %}
    <a class="ms-2half" href="#leave-a-comment"><img src="{{ url_for('blog.static', filename='blog/blogpage/images/icon_comment_custom_blue.svg', _external=True) }}" title="yapping" width=16px height=16px></img></a>
    <input id="copy-permanent-link" class="ms-2" type="image" src="{{ url_for('static', filename='images/icon_link.svg', _external=True) }}" title="Copy permanent link (free malware included)" width=20px height=20px></input>
  </div>

  {%- if current_user.is_authenticated %}
    <a class="auth-true btn-custom-orange btn btn-primary mt-2" href="{{ url_for('admin.edit_blogpost', post_id=post.id) }}" role="button">Edit/delete post</a>
  {%- else %}
    <a class="auth-true btn-custom-orange btn btn-primary mt-2" href="{{ url_for('admin.edit_blogpost', post_id=post.id) }}" role="button" hidden>Edit/delete post</a>
  {%- endif %}
</div>
<hr>

<div id="post-content" class="mt-2">
  {{ post.content |safe }}
</div>

<hr class="doublehr">

<div id="leave-a-comment">
  <h2 class="comment-section-headers shrinking-font-14">Leave a comment</h2>
  {{ wtf.quick_form(add_comment_form, class="comment-add-form ajax-add-comment", bottom_margin=2, autofocus_first=false) }}
</div>
<hr>

<div id="comment-list" class="pb-3">
  <h2 class="comment-section-headers shrinking-font-14 mb-0">Comments <span class="gray">({{ post.get_comment_count() }})</span></h2>
  <div class="d-flex flex-shrink-0">
    <div class="w-100 flex-shrink-0">
      {%- for comment in comments recursive %}
        {%- if comment.depth == loop.depth0 %}
          {%- if comment.depth != 0 %}
            <div class="flex-grow-1 ms-3">
          {%- endif %}
          {%- set descendants = comment.get_descendants_list(post) %}
          {%- if comment.author.lower() |replace(" ", "") == config["VERIFIED_AUTHOR"] %}
          <div class="comment card border-custom-orange border-3px{%- if comment.depth == 0 %} mt-3{%- else %} mt-1{%- endif %}">
            <div class="card-body pb-2">
                <h3 class="comment-author d-flex align-items-center me-1">
                  <span class="me-2">{{ comment.author }}</span><img class="img-verified-checkmark" src="{{ url_for('blog.static', filename='blog/blogpage/images/icon_verified.svg', _external=True) }}" title="Actually verified, unlike Twitter.">
                </h3>
          {%- else %}
          <div class="comment card{%- if comment.depth == 0 %} mt-3{%- else %} mt-1{%- endif %}">
            <div class="card-body pb-2">
              <h3 class="comment-author">{{ comment.author }}</h3>
          {%- endif %}
              <div class="comment-content gray">{{ comment.content |safe }}</div>
              <div class="mb-1"><small>{{ moment(comment.timestamp).format("lll") }} ({{ moment(comment.timestamp).fromNow() }})</small></div>
              
              {%- if comment.depth < 6 %}
                {{ wtf.quick_form(reply_comment_button, id="comment-reply-form-" ~ comment.id, class="comment-reply-form", btn_type="link-no-underline", btn_color="custom-orange", bottom_margin=0) }}
                {{ wtf.quick_form(add_comment_form, id="comment-reply-add-form-" ~ comment.id, class="comment-add-form ajax-add-comment", bottom_margin=2, hidden=true) }}
              {%- else %}
                <p class="comment-nest-limit-text custom-orange mb-0">It's gonna get ugly if you keep replyingâ€¦</p>
              {%- endif %}

              {%- if current_user.is_authenticated %}
                {{ wtf.quick_form(delete_comment_button, id="comment-delete-form-" ~ comment.id, class="auth-true ajax-delete-comment comment-delete-form", btn_type="link-no-underline", btn_color="custom-pink", bottom_margin=0) }}
              {%- else %}
                {{ wtf.quick_form(delete_comment_button, id="comment-delete-form-" ~ comment.id, class="auth-true ajax-delete-comment comment-delete-form", btn_type="link-no-underline", btn_color="custom-pink", bottom_margin=0, hidden=true) }}
              {%- endif %}
            </div>
          </div>
          {%- if descendants %}
            <div>{{ loop(descendants) }}</div>
          {%- endif %}

          {%- if comment.depth != 0 %}
            </div>
          {%- endif %}
        {%- endif %}
      {%- endfor %}
    </div>
  </div>
</div>
{%- endblock %}

{%- block js %}
{{ super() }}
<script src="{{ url_for('blog.static', filename='blog/blogpage/js/comments.js', _external=True) }}"></script>
{%- endblock %}
